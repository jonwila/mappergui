<!DOCTYPE html>
<html>
<head>
	<title>LibMapper GUI Matrix Style</title>
	<script src="js/Signal.js"></script>
	<link rel="stylesheet" type="text/css" href="style/style.css" />

<!-- jQueryUI slider -->	
<link rel="stylesheet" href="css/ui-lightness/jquery-ui-1.10.0.custom.css" />
<script src="js/jquery-1.9.0.js"></script>
<script src="js/jquery-ui-1.10.0.custom.js"></script>

<style>
	.slider { margin: 20px 0 30px; }
	/*Bar background */
	.scroll-bar-wrap { clear: left; padding: 0 4px 0 2px; background-color: #fff; -moz-border-radius: 14px; -webkit-border-radius: 14px; border-radius: 14px; -moz-background-clip: padding; -webkit-background-clip: padding-box; background-clip: padding-box; }
	.scroll-bar-wrap .ui-slider { background: none; border:0; height: 20px; margin: 0 auto;  }
	.scroll-bar-wrap .ui-handle-helper-parent { position: relative; width: 100%; height: 100%; margin: 0 auto; }
	.scroll-bar-wrap .ui-slider-handle { position: absolute; top:2px; height: 14px; z-index: 2; -moz-border-radius: 12px; -webkit-border-radius: 12px; border-radius: 12px; -moz-background-clip: padding; -webkit-background-clip: padding-box; background-clip: padding-box; }
	.ui-state-default { background: url("slider.png") repeat-x scroll 50% 50% #EEEEEE; border: 1px solid #666; } /*slider up*/
	/*hover and selected*/
	.ui-state-hover, .ui-state-focus { background: url("slider-hover.png") 50% 50% repeat-x #dddddd; border: 1px solid #999; }
	.scroll-bar-wrap .ui-slider-handle .ui-icon { margin: -8px auto 0; position: relative; top: 50%; background: url("ui-icons_cccccc_256x240.png") 0 -224px no-repeat; height: 16px; width: 16px; display: block; overflow: hidden; text-indent: -99999px;}
	body {
		background-color: #d2d2d2;
		width: 900px;
		margin: 0 auto;
		font-family: Arial, Helvetica, sans-serif;
	}
	a, a:active, a:visited { color: #607890; text-decoration: none; outline-color: -moz-use-text-color; outline-style: none; outline-width: medium; }
	a:hover { color: #036; }
	svg{background: #ffffff; margin-left:4px;}
</style>	

<script>

	//---------------------------------------------------- //
	//                    Global Vars                      //
	//---------------------------------------------------- //
	
	var svg, svgRowLabels, svgColLabels;	// holding <SVG> elements for easy reference 
	var svgNS = "http://www.w3.org/2000/svg";
	
	var cellWidth = 30;
	var cellHeight = 30;
	var cellRoundedCorner = 4;
	var cellMargin = 1;
	var labelMargin = 5;
	
	var svgWidth = 600;
	var svgHeight = 400;
	var vboxW = svgWidth;
	var vboxH = svgHeight;
	var vboxX = 0;
	var vboxY = 0;
	var contentW;
	var contentH;
	
	var colLabelsH = 150;
	var rowLabelsW = 200;
	
	//temp vars
	var nColsInit = 20;
	var nRowsInit = 8;
	
	//---------------------------------------------------- //
	//				     LibMapper Data                    //
	//---------------------------------------------------- //
	
	var cols = new Array(); 		// to hold source signals
	var rows = new Array(); 		// to hold destination signals
	var connections = new Array();
	
	//---------------------------------------------------- //
	//				     GUI Variables                     //
	//---------------------------------------------------- //
	
	var selectedCell = null; 	// hold a reference to the selected cell
	var mousedOverCell = null;	// hold a reference to the cell that's moused over
																
	
	//---------------------------------------------------- //
	//					    Initialize                     //
	//---------------------------------------------------- //
	
	function init()
	{
		svg = document.getElementById("svgGrid");
		svg.setAttribute("width", svgWidth);
		svg.setAttribute("height", svgHeight);
		svg.setAttribute("viewBox", toViewBoxString(vboxX, vboxY, vboxW, vboxH));

		svgRowLabels = document.getElementById("svgRows");
		svgRowLabels.setAttribute("width", rowLabelsW);
		svgRowLabels.setAttribute("height", svgHeight);
		
		svgColLabels = document.getElementById("svgCols");
		svgColLabels.setAttribute("width", svgWidth);
		svgColLabels.setAttribute("height", colLabelsH);
		
		initScrollBars();
		
		// init with fake data for now
		for(var i=nColsInit; i>0;i--)
			addSourceSignal(new Signal("Source " + i), 0);
		for(var j=nRowsInit; j>0;j--){
			addDestinationSignal(new Signal("Destination " + j), 0);
		}
	
	}
	
	function addSourceSignal(name)
	{
		insertColAt(name, 0);
		cols.push(new Signal(name));
		contentW = cols.length*(cellWidth+cellMargin);
		sizeScrollbar();
	}
	function addDestinationSignal(name)
	{
		insertRowAt(name, 0);
		rows.push(new Signal(name));
	}
	
	/**
	 * insert a new signal at the specified index
	 * reposition the rows with index greater than the specified index
	 * reposition the column labels 
	 * create the new row (containg cells + label)
	 * update IDs of all rows that are connected
	 */
	function insertRowAt(signal, index){
		
		if(index > rows.length)
		{
			alert("invalid row index");
			return;
		}
		
		var i,j;
		var row, y, cell;
		var newRow, newRowY, newRowLabel;
		var rowLabel;
		var connection;
		
		for(i=rows.length-1; i>=index; i--)	// for each row after index
		{
			// reposition the y position of the entire row group and label
			row = svg.getElementById("row" + i);
			y = (i+1)*(cellHeight+cellMargin);
			row.setAttribute("transform", "translate(0,"+ y +")");
			
			//update row ID
			row.setAttribute("id", "row" + (i+1));
			
			// update the row's label ID
			rowLabel = svgRowLabels.getElementById("rowLabel" + i);
			if(rowLabel != null){
				rowLabel.setAttribute("id", "rowLabel" + (i+1));
				rowLabel.setAttribute("y", y+(cellHeight/2)+4);
			}
			
			// update IDs of each cell inside the row
			for(j=0; j<cols.length; j++)
			{
				// change ID of cells
				cell = row.childNodes[j];
				cell.setAttribute("id", i+1 + "," + j);
			}
		}
	
		// create a new row group	
		newRow = document.createElementNS(svgNS,"g");
		newRowY = index*(cellHeight+cellMargin);
		newRow.setAttribute("transform", "translate(0,"+ newRowY +")");
		newRow.setAttribute("id", "row" + index);
				
		// create new cells for the new row
		for(j=0; j<cols.length; j++)
		{
			newRow.appendChild(createCell(index, j));
		}
		
		// create row label for the new row
		newRowLabel = document.createElementNS(svgNS,"text");
		newRowLabel.setAttribute("id", "rowLabel" + index.toString()  );
		newRowLabel.setAttribute("x", labelMargin);
		newRowLabel.setAttribute("y", newRowY+(cellHeight/2)+4);		// plus 4 to center vertically MAKE DYNAMIC!
		newRowLabel.setAttribute("class","label");
		newRowLabel.appendChild(document.createTextNode(signal.name));	
		svgRowLabels.appendChild(newRowLabel);
		
		// add the new row with its cells and label to the grid
		svg.appendChild(newRow);
		
		// update ID's of all connections past the new col index
		for(i=0; i<connections.length; i++)
		{
			connection = connections[i];
			var conCol = getColIndex(connection.id.substr(("connection").length));
			var conRow = getRowIndex(connection.id.substr(("connection").length));
			if (conRow >= index){
				conRow++;
				connection.id = "connection" + conRow + "," + conCol;
			}
		}
	}
	
	
	
	/**
	 * insert a column at the specified index
	 * reposition the columns cell and label with index greater than the specified index
	 * reposition the row labels 
	 * create the new column (containg cells + label)
	 * update IDs of all rows that are connected
	 */
	function insertColAt(signal, index){
		
		if(index > cols.length)
		{
			alert("invalid col index");
			return;
		}
		
		// reposition cols after the index
		// change the id's of each cell in the col to match new location in the grid
		
		var i,j;
		var cell, colLabel, rowLabel;
		var newCell, newLabel;
		var connection;
		
		for(j=cols.length-1; j>=index; j--)	// for each column after index
		{
			for(i=0; i<rows.length; i++)
			{
				cell = document.getElementById(makeId(i,j));
				cell.setAttribute("x",(j+1)*(cellWidth+cellMargin));	// reposition the cell
				cell.setAttribute("id", makeId(i, j+1));				// update the id
			}
			
			//reposition the col label
			colLabel = svgColLabels.getElementById("colLabel" + j);
			if(colLabel != null)
			{
				colLabel.setAttribute("transform","translate(" + ((j+1)*(cellWidth+cellMargin)+11).toString() + "," + labelMargin + ")rotate(90)");
				colLabel.setAttribute("id", "colLabel"+(j+1));
			}
		}
	
		for(var i=0; i<rows.length; i++)
		{
			// create new cells
			newCell = createCell(i, index);
			var c2 = document.getElementById("row" + i);
			var c3 = c2.childNodes[index]; 
			c2.insertBefore(newCell, c3);
		}
			
		//create new COL Label
		newLabel = document.createElementNS(svgNS,"text");
		newLabel.setAttribute("id", "colLabel" + index.toString()  );
		var xPos = index*(cellWidth+cellMargin)+11;			// pluss 11 MAKE DYNAMIC!
		var yPos = labelMargin;
		newLabel.setAttribute("class","label");
		newLabel.setAttribute("transform","translate(" + xPos + "," + yPos + ")rotate(90)");
		newLabel.appendChild(document.createTextNode(signal.name));	
		svgColLabels.insertBefore(newLabel, svgColLabels.childNodes[index]);
		
		
	
		// update ID's of all connections past the new col index
		for(i=0; i<connections.length; i++)
		{
			var connection = connections[i];
			var conCol = getColIndex(connection.id.substr(("connection").length));
			var conRow = getRowIndex(connection.id.substr(("connection").length));
			if (conCol >= index){
				conCol++;
				connection.id = "connection" + conRow + "," + conCol;
			}
		}
	}
	
	function createCell(row, col)
	{
		var cell = document.createElementNS(svgNS,"rect");
		cell.setAttribute("id", makeId(row,col));
		cell.setAttribute("x",col*(cellWidth+cellMargin));
		cell.setAttribute("y", 0);
		cell.setAttribute("rx", cellRoundedCorner);
		cell.setAttribute("ry", cellRoundedCorner);
		cell.setAttribute("width",cellWidth);
		cell.setAttribute("height",cellHeight);
		cell.setAttribute("class","cell_up");
		cell.addEventListener("mouseover", cellMouseOverHandler);
		cell.addEventListener("mouseout", cellMouseOverHandler);
		cell.addEventListener("click", onCellClick);
		return cell;
	}
	
	
	//---------------------------------------------------- //
	//					Event Handlers                     //
	//---------------------------------------------------- //
	
	/**
	 * on cell mouseover, highlights corresponding row and columns
	 * order matters.. I'm styling the row and column first, then the moused over cell
	 * must handle special cases: if the cell is the selected cell or has a connection
	 */
	function cellMouseOverHandler(evt)    
	{
		// keep reference to cell mouse is over
		if(evt.type == "mouseover")
			mousedOverCell = evt.target;	
		else if (evt.type == "mouseout")
			mousedOverCell = null;	
			
		// row can be found from it's parent <g>
		// columns must be found differently (below)	
		var row = evt.target.parentNode;	
		
		var selectedRow = getRowIndex(evt.target.id);
		var selectedCol = getColIndex(evt.target.id);
		
		// style row cells
		
		for(var i=0; i<cols.length; i++)
		{
			var curNode = row.childNodes[i];
			var className = curNode.getAttribute("class");
			if(className.indexOf("cell_connected") == -1)
			{
				className = (className.indexOf("cell_selected") == -1)? "" : "cell_selected "; 
				if(evt.type == "mouseover")
					row.childNodes[i].setAttribute("class", className + "row_over");
				else if(evt.type == "mouseout")
					row.childNodes[i].setAttribute("class",className + "cell_up");
			}
		}
		
		// style row label
		
		//var rowLabel = row.childNodes[cols.length];
		var rowLabel = svg.getElementById("rowLabel" + selectedRow);
		if(rowLabel != null)
		{
			if(evt.type == "mouseover")
				rowLabel.setAttribute("class","label_over");
			else if(evt.type == "mouseout")
				rowLabel.setAttribute("class","label");
		}
		
		// style col cells
	
		for(var i=0; i<rows.length; i++)
		{
			var currentId = makeId(i,selectedCol);
			var colCell = svg.getElementById(currentId);
			var className = colCell.getAttribute("class"); 
			if(className.indexOf("cell_connected") == -1)
			{
				className = (className.indexOf("cell_selected") == -1)? "" : "cell_selected ";
				if(evt.type == "mouseover")
					colCell.setAttribute("class", className+"row_over");
				else if(evt.type == "mouseout")
				{
					colCell.setAttribute("class", className+"cell_up");			
				}
			}
		}
		
		// style col label
		
		var colLabel = svg.getElementById("colLabel" + selectedCol);
		if(colLabel != null)
		{
			if(evt.type == "mouseover")
				colLabel.setAttribute("class","label_over");
			else if(evt.type == "mouseout")
				colLabel.setAttribute("class","label");
		}
	};
	
	/**
	 * on cell click, set the cell as selected
	 * handle removing the previously selected cell and the special case where the previous was null
	 */
	
	function onCellClick(evt)    
	{
		var cell = evt.target;
	
		if(selectedCell == null)
		{
			// set the clicked cell as selected
			addCellClass("cell_selected", cell);
			selectedCell = cell;
		}
		else if(cell.id != selectedCell.id)	
		{	
			// clear last selected cell
			removeCellClass("cell_selected", selectedCell);
			// set the clicked cell as selected
			addCellClass("cell_selected", cell);
			selectedCell = cell;
		}	
		else	// already selected, so deselect
		{
			removeCellClass("cell_selected", cell);
			selectedCell = null;
		}
		
		
		// load cell details into info PANE
		//
		// ...
	
	}
	
	/**
	 * toggles a connection
	 * checks if the cell already has a connection
	 */
	function toggleConnection()
	{
		var i;						// to hold index to point into connections array
		var isConnected = false;	// flag for loop
		
		// do nothing if there is no cell selected
		if(selectedCell == null)	
			return;
		
		// loop through connections array to see if the cell already has a connection 
		for(i=0; i<connections.length; i++)
		{
			if(connections[i].id == "connection" + selectedCell.id){
				isConnected = true;
				break;
			}
		}
		
		// toggle the connection
		
		if(isConnected)	// is already a connection, so remove it
		{
			//remove from connections array
			connections.splice(i,1);		
											
			//style the cell
			
			if(mousedOverCell != null)	//style when mouse is over the toggled cell's row/col
			{	
				var mouseRow = getRowIndex(mousedOverCell.id);
				var mouseCol = getColIndex(mousedOverCell.id);
				var selectedRow = getRowIndex(selectedCell.id);
				var selectedCol = getColIndex(selectedCell.id);
				if(mouseRow == selectedRow || mouseCol == selectedCol)
					selectedCell.setAttribute("class", "row_over cell_selected");
				else	
					selectedCell.setAttribute("class", "cell_up cell_selected");
			}
			else	// style when no cell is moused over 
				selectedCell.setAttribute("class", "cell_up cell_selected");
				
		
		}
		else	// not already a connection, create the new connection
		{
			var row = getRowIndex(selectedCell.id);
			var col = getColIndex(selectedCell.id);
			var connection = new Connection(row, col);	// create a new connection object
			connections.push(connection);				// add to the connections array 
			selectedCell.setAttribute("class", "cell_connected cell_selected");	//style appropriately for GUI	
		}
	
	};
	
	//---------------------------------------------------- //
	//					Keyboard Handler                   //
	//---------------------------------------------------- //
	
	function keyboardHandler(event)
	{
		if(cols.length==0 || rows.length==0)
			return;
	
		// enter or space to toggle a connection
		if(event.keyCode == 13 || event.keyCode == 32)	
		{
			if(selectedCell != null)
		  		toggleConnection();
		}	
		
		// movement arrows to move the selected
		else if (event.keyCode == 37 || event.keyCode == 38 || event.keyCode == 39 || event.keyCode == 40)	
		{
			if(selectedCell != null)	// cases where there is a previously selected cell
			{
				var currentPos = getCellIndex(selectedCell.id);
				removeCellClass("cell_selected", selectedCell);
				
				switch(event.keyCode)	
				{
					case 37:	// left
						if(currentPos[1] > 0)
							selectedCell = document.getElementById(makeId(currentPos[0], currentPos[1]-1));
						else
							selectedCell = document.getElementById(makeId(currentPos[0], cols.length-1));
					  break;
					case 38:	// up
						if(currentPos[0] > 0)
							selectedCell = document.getElementById(makeId(currentPos[0]-1, currentPos[1]));
						else
							selectedCell = document.getElementById(makeId(rows.length-1, currentPos[1]));
					  break;
					case 39:	// right
						if(currentPos[1] < cols.length-1)
							selectedCell = document.getElementById(makeId(currentPos[0], currentPos[1]+1));
						else
							selectedCell = document.getElementById(makeId(currentPos[0], 0));
					  break;
					case 40:	// down
						if(currentPos[0] < rows.length-1)
							selectedCell = document.getElementById(makeId(currentPos[0]+1, currentPos[1]));
						else
							selectedCell = document.getElementById(makeId(0, currentPos[1]));
					  break;
				}
				
				
			}
			else	// cases where there is no selected cell
			{
				switch(event.keyCode)	
				{
					case 37:	// left 
						selectedCell = document.getElementById(makeId(0,cols.length-1));
					  break;
					case 38:	// up
						selectedCell = document.getElementById(makeId(rows.length-1,0));
					  break;
					case 39:	// right
						selectedCell = document.getElementById(makeId(0,0));
					  break;
					case 40:	// down
						selectedCell = document.getElementById(makeId(0,0));
					  break;
				}
			}
			
			addCellClass("cell_selected", selectedCell);
			
		}
	}
	
	/**
	 * Disables my keyboard shortcuts from moving the browser's scroll bar 
	 http://stackoverflow.com/questions/2020414/how-to-disable-page-scrolling-in-ff-with-arrow-keys
	 */
	document.onkeydown = function(e) {
	    var k = e.keyCode;
	    if((k >= 37 && k <= 40) || k == 32) {
	        return false;
	    }
	}
	

	
	
	function initScrollBars()
	{
		// set width of scroll bar wrapper
		$(".scroll-bar-wrap").css("width", svgWidth);	
		
		//build slider
		var scrollbar = $( ".scroll-bar" ).slider({
			slide: function( event, ui ) {
				if ( contentW > vboxW ) {
					vboxX =  ui.value / 100 * (-1) * ( vboxW - contentW );		// 0 >= ui.value <= 100
				}else {
					vboxX = 0;
				}
				svg.setAttribute("viewBox", toViewBoxString(vboxX, vboxY, vboxW, vboxH));
				svgColLabels.setAttribute("viewBox", toViewBoxString(vboxX, 0, vboxW, colLabelsH));
			}
		});
		
		// wrapper div for custom handle size (I think!) 
		var handleHelper = scrollbar.find( ".ui-slider-handle" )
		.wrap( "<div class='ui-handle-helper-parent'></div>" ).parent();
	
		//init scrollbar size
		setTimeout( sizeScrollbar, 10 );//safari wants a timeout
		
	};
	
	//NOT USED YET
	function moveScrollbar(){
		var remainder = scrollPane.width() - scrollContent.width();
		var leftVal = scrollContent.css( "margin-left" ) === "auto" ? 0 :
			parseInt( scrollContent.css( "margin-left" ) );
		var percentage = Math.round( leftVal / remainder * 100 );
		scrollbar.slider( "value", percentage );
	};
	
	function sizeScrollbar() 
	{
		var scrollbar = $( ".scroll-bar" );
		var handleHelper = scrollbar.find(".ui-handle-helper-parent");
		var handleSize = (contentW < vboxW)? svgWidth : vboxW/contentW*svgWidth;
		scrollbar.find( ".ui-slider-handle" ).css({
			width: handleSize,
			"margin-left": -handleSize / 2
		});
		handleHelper.width( "" ).width( scrollbar.width() - handleSize );
	}

	function tempBtnHandler(val)
	{
	//	if(isNaN(inputbox.value))
	//		alert("insert a valid integer to add col/row");
	//	else
	//	{
			if(val=="row")
				addDestinationSignal(new Signal("New Row (" + (rows.length+1) + ")" ), 0);
			else{
				for(var j=0; j<20;j++){
					addSourceSignal(new Signal("New Col (" + (cols.length+1) + ")" ), 0);
				}
			}
	//	}	
	}
</script> 
</head>
 
<body onload="init()" 
	  onkeyup="keyboardHandler(event)">
 
	<button onclick="toggleConnection()">Toggle</button>&nbsp;&nbsp;&nbsp;
	<button onclick="tempBtnHandler('row')">Add Row at 0</button>
	<!-- <INPUT TYPE="text" NAME="inputbox" id="inputbox" VALUE="0" maxlength="3"> -->
	<button onclick="tempBtnHandler('col')">Add Col at 0</button><br /><br />
 	 
 	 <!-- SVG Canvas: Grid of cells -->
	<svg id="svgGrid" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
	<svg id="svgRows" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
	<svg id="svgCols" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
	style="clear:both;"></svg>
	
	
	<!-- Horizontal Scroll Bar -->
	<div class="scroll-bar-wrap ui-widget-content ui-corner-bottom">
		<div class="scroll-bar"></div>
	</div>
	
	<p>Use arrow keys to navigate the grid. Use the spacebar or hit 'enter' to toggle connection.</p>	
	<p>Or use mouse and "toggle" button on top</p>	 

</body>
</html>